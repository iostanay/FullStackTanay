{% extends "base.html" %}

{% block title %}Contact - Tanay Bhattacharjee{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0"><i class="fas fa-envelope me-2"></i>Send Me a Message</h2>
        </div>
        <div class="card-body">
          <form id="contactForm" novalidate>
            <div class="mb-3">
              <label for="name" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="name" placeholder="Your Name" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Your Email</label>
              <input type="email" class="form-control" id="email" placeholder="your@email.com" required>
            </div>
            <div class="mb-3">
              <label for="message" class="form-label">Your Message</label>
              <textarea class="form-control" id="message" rows="5" placeholder="Type your message here..." required></textarea>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Send Message
            </button>
            <div id="formMessage" class="mt-3" style="display: none;"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  function initContactForm() {
    const contactForm = document.getElementById('contactForm');
    const submitBtn = document.getElementById('submitBtn');
    const formMessage = document.getElementById('formMessage');

    if (!contactForm || !submitBtn) return;

    contactForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const nameField = document.getElementById('name');
      const emailField = document.getElementById('email');
      const messageField = document.getElementById('message');

      const name = nameField.value.trim();
      const email = emailField.value.trim();
      const message = messageField.value.trim();

      // Reset validation styles
      [nameField, emailField, messageField].forEach(field => {
        field.classList.remove('is-invalid', 'is-valid');
      });

      // Validate fields
      if (!name) {
        highlightField(nameField, false);
        return showMessage('Please enter your name.', 'error');
      } else {
        highlightField(nameField, true);
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email) {
        highlightField(emailField, false);
        return showMessage('Please enter your email.', 'error');
      } else if (!emailRegex.test(email)) {
        highlightField(emailField, false);
        return showMessage('Please enter a valid email address.', 'error');
      } else {
        highlightField(emailField, true);
      }

      if (!message || message.length < 10) {
        highlightField(messageField, false);
        return showMessage('Please enter a message (at least 10 characters).', 'error');
      } else {
        highlightField(messageField, true);
      }

      // Disable button while submitting
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';

      try {
        console.log('Sending contact form data:', { name, email, message });
        
        const res = await fetch("https://fullstacktanay-production.up.railway.app/api/contacts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, message })
        });

        console.log('Response status:', res.status);
        const data = await res.json();
        console.log('Response data:', data);

        if (res.ok) {
          showMessage('✅ Message sent successfully! I\'ll get back to you soon.', 'success');
          contactForm.reset();
          // Reset validation styles after successful submission
          [nameField, emailField, messageField].forEach(field => {
            field.classList.remove('is-valid');
          });
        } else {
          showMessage(data.error || '❌ Failed to send message. Please try again.', 'error');
        }
      } catch (err) {
        console.error('Error sending message:', err);
        showMessage('❌ Network error. Please check your connection and try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Message';
      }
    });

    function highlightField(field, isValid) {
      field.classList.remove('is-invalid', 'is-valid');
      field.classList.add(isValid ? 'is-valid' : 'is-invalid');
    }

    function showMessage(msg, type) {
      formMessage.textContent = msg;
      formMessage.className = `alert alert-${type === 'success' ? 'success' : 'danger'} mt-3`;
      formMessage.style.display = 'block';
      formMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

      setTimeout(() => {
        formMessage.style.display = 'none';
      }, type === 'success' ? 5000 : 8000);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initContactForm);
  } else {
    initContactForm();
  }
})();
</script>
{% endblock %}
